---
/**
 * Contact Form Feature - UI Component
 * Features Layer - Contact form functionality with i18n support
 */

import { useFeatureTranslations } from '../../../shared/lib/i18n';
import { contactFormI18n } from '../i18n';
import type { ContactFormProps } from '../model/types';

interface Props extends ContactFormProps {}

const { class: className = '', id = 'contact-form', action = '#', method = 'POST' } = Astro.props;

const { t } = useFeatureTranslations(new URL(Astro.request.url), contactFormI18n);
---

<div class={`contact-form-container ${className}`}>
	<form {id} class="contact-form max-w-lg mx-auto space-y-6" {action} {method} novalidate>
		<div class="form-group">
			<label
				for="contact-name"
				class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
			>
				{t('nameLabel')}
				<span class="text-red-500">*</span>
			</label>
			<input
				type="text"
				id="contact-name"
				name="name"
				class="contact-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
				placeholder={t('namePlaceholder')}
				required
				aria-describedby="name-error"
			/>
			<div
				id="name-error"
				class="error-message mt-1 text-sm text-red-600 hidden"
				role="alert"
			>
			</div>
		</div>

		<div class="form-group">
			<label
				for="contact-email"
				class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
			>
				{t('emailLabel')}
				<span class="text-red-500">*</span>
			</label>
			<input
				type="email"
				id="contact-email"
				name="email"
				class="contact-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
				placeholder={t('emailPlaceholder')}
				required
				aria-describedby="email-error"
			/>
			<div
				id="email-error"
				class="error-message mt-1 text-sm text-red-600 hidden"
				role="alert"
			>
			</div>
		</div>

		<div class="form-group">
			<label
				for="contact-message"
				class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
			>
				{t('messageLabel')}
				<span class="text-red-500">*</span>
			</label>
			<textarea
				id="contact-message"
				name="message"
				rows="5"
				class="contact-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white resize-vertical"
				placeholder={t('messagePlaceholder')}
				required
				aria-describedby="message-error"></textarea>
			<div
				id="message-error"
				class="error-message mt-1 text-sm text-red-600 hidden"
				role="alert"
			>
			</div>
		</div>

		<div class="form-submit">
			<button
				type="submit"
				class="submit-button w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
				data-submit-text={t('submitButton')}
				data-submitting-text={t('submittingButton')}
			>
				{t('submitButton')}
			</button>
		</div>

		<!-- Status messages -->
		<div
			id="form-success"
			class="success-message mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-md hidden"
			role="alert"
		>
			{t('successMessage')}
		</div>

		<div
			id="form-error"
			class="error-message mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md hidden"
			role="alert"
		>
			{t('errorMessage')}
		</div>
	</form>
</div>

<script
	is:inline
	define:vars={{
		translations: {
			requiredField: t('requiredField'),
			invalidEmail: t('invalidEmail'),
			submitButton: t('submitButton'),
			submittingButton: t('submittingButton'),
			successMessage: t('successMessage'),
			errorMessage: t('errorMessage'),
		},
	}}
>
	// Contact form functionality
	document.querySelectorAll('.contact-form').forEach(form => {
		const submitButton = form.querySelector('.submit-button');
		const successMessage = form.querySelector('#form-success');
		const errorMessage = form.querySelector('#form-error');

		// Email validation regex
		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

		// Validate individual field
		const validateField = (field, showError = true) => {
			const value = field.value.trim();
			const errorElement = form.querySelector(`#${field.name}-error`);
			let isValid = true;
			let errorText = '';

			if (!value) {
				isValid = false;
				errorText = translations.requiredField;
			} else if (field.type === 'email' && !emailRegex.test(value)) {
				isValid = false;
				errorText = translations.invalidEmail;
			}

			if (errorElement) {
				if (!isValid && showError) {
					errorElement.textContent = errorText;
					errorElement.classList.remove('hidden');
					field.classList.add('border-red-500');
				} else {
					errorElement.classList.add('hidden');
					field.classList.remove('border-red-500');
				}
			}

			return isValid;
		};

		// Real-time validation
		form.querySelectorAll('.contact-input').forEach(input => {
			input.addEventListener('blur', () => validateField(input));
			input.addEventListener('input', () => {
				if (input.classList.contains('border-red-500')) {
					validateField(input);
				}
			});
		});

		// Form submission
		form.addEventListener('submit', async e => {
			e.preventDefault();

			// Hide previous messages
			successMessage?.classList.add('hidden');
			errorMessage?.classList.add('hidden');

			// Validate all fields
			const inputs = form.querySelectorAll('.contact-input');
			let isFormValid = true;

			inputs.forEach(input => {
				if (!validateField(input)) {
					isFormValid = false;
				}
			});

			if (!isFormValid) {
				return;
			}

			// Update button state
			if (submitButton) {
				submitButton.disabled = true;
				submitButton.textContent = translations.submittingButton;
			}

			try {
				// Get form data
				const formData = new FormData(form);

				// Import contact service functions dynamically for client-side use
				const { 
					processContactFormData, 
					createContactPayload, 
					storeContactLocally, 
					logContactAttempt, 
					submitContactData 
				} = await import('../lib/contactService.js');

				// Process form data using feature service
				const contactData = processContactFormData(formData);
				
				// Log contact attempt for development/analytics
				logContactAttempt(contactData);

				// Prepare data for backend submission
				const requestPayload = createContactPayload(contactData);

				// Store locally for development/future retrieval
				storeContactLocally(contactData);

				// Submit to backend (currently simulated)
				await submitContactData(requestPayload);

				// Show success message
				successMessage?.classList.remove('hidden');
				form.reset();

				// Reset validation states
				inputs.forEach(input => {
					input.classList.remove('border-red-500');
					const errorElement = form.querySelector(`#${input.name}-error`);
					errorElement?.classList.add('hidden');
				});
			} catch (error) {
				// Show error message
				errorMessage?.classList.remove('hidden');
				console.error('Form submission error:', error);
			} finally {
				// Reset button state
				if (submitButton) {
					submitButton.disabled = false;
					submitButton.textContent = translations.submitButton;
				}
			}
		});
	});
</script>
